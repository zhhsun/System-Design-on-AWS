# 第12章 AWS编排服务

对于大规模运行系统，多个组件相互交互和协调以执行称为编排的任何任务。应用程序组件之间的通信和协调可以由不同的AWS服务进行管理，我们可以根据我们的用例选择服务。在本章中，我们将深入研究核心编排服务，如简单通知服务(SNS)，它可以用于向多个订阅者广播消息，以及AWS步骤功能，它可以用于协调和执行不同的AWS或定制服务，以特定的顺序。

我们将首先讨论有助于在AWS云环境中实现发布者-订阅者设计模式的AWS服务，如Simple Queue Service (SQS)、针对Apache Kafka (MSK)的SNS和Amazon Managed Streaming，然后再讨论监控、授权和认证服务，如CloudWatch、Amazon Cognito和AWS IAM。

## Apache Kafka中的Amazon管理流

我们在第8章中讨论了消息代理及其体系结构。Apache Kafka是一个开源消息代理和事件流平台，广泛用于设计事件驱动架构。AWS为Apache Kafka提供托管服务，以减少客户端的运营开销，使他们能够更多地专注于开发软件，而不是Apache Kafka集群的基础设施部署和维护。Amazon MSK向客户公开了控制平面操作，如集群的创建、更新和删除，以及数据平面操作，如事件的生产和消费。

在设置Amazon MSK集群时，我们指定代理节点的数量和类型以及每个AZ中的存储容量。必须至少选择两个AZ以确保高集群可用性。Amazon MSK自动检测代理故障，并用具有相同IP地址的健康节点替换该节点。与AWS环境中的其他多个服务类似，Amazon MSK也提供两种容量模式:Serverless和Provisioned。我们可以选择无服务器选项，让AWS负责基础设施配置，而provisioning允许我们选择节点和存储配置。此外，代理节点之间的协调和同步是通过Zookeeper(在第5章中讨论)节点进行管理的，Amazon MSK为我们创建了这些节点。

集群设置中的下一组配置与网络、安全性和监视相关。您应该选择应该在其中启动代理的az和子网，然后定义安全措施。首先，让我们讨论一下客户端如何访问Amazon MSK集群:

*未经身份验证的访问*

顾名思义，我们可以允许客户机直接访问我们的集群，而不需要任何身份验证，尽管这不是配置访问控制的推荐方法。

*基于IAM角色的访问*

对Amazon MSK集群的访问通过IAM角色和关联的IAM策略进行管理。

*SASL /安全身份验证*

SASL/SCRAM是指简单认证和安全层/盐渍挑战响应机制。我们本质上使用客户端的登录凭据(用户名和密码)，并将它们存储到与秘密资源关联的Amazon Secrets Manager中。这提供了一种安全的集群访问方法，而Amazon Secrets Manager全权负责审计、更新和轮换凭据。此外，我们可以根据需要在集群之间共享相同的凭据。

*TLS认证*

我们可以对客户机访问使用TLS身份验证，并将这些证书存储在Amazon Certificate Manager (ACM)中。

为了数据安全，我们可以对静态和传输中的数据进行加密。静态加密可以通过AWS托管或客户托管密钥启用。对于传输中的加密，我们可以对集群内的通信使用TLS加密，并对代理和客户端之间的通信使用明文或TLS加密，或者两者都使用。

Amazon Kinesis是另一个提供数据流功能的服务，类似于Amazon MSK，我们将在下一章深入研究它。AWS还提供了SNS和SQS(我们将在稍后讨论)，它们可用于创建发布事件的主题，并且可以由多个消费者(如SQS)使用。在第11章中，我们讨论了为什么客户可能更喜欢EKS而不是ECS来启动他们的应用程序。类似的类比也适用于这里，Kafka是一个开源的消息代理服务，可以用来代替SNS-SQS。您可能选择它的原因也很相似—您可能正在将工作负载迁移到AWS Cloud或在AWS Cloud上运行现有工作负载，或者您只是喜欢对开发功能具有完全可见性的开源软件。现在让我们把注意力转移到SQS和SNS上，它们可以代替Amazon MSK来管理主题和队列。

## Amazon Simple Queue Service (SQS)

第1章介绍了异步通信的概念，第7章介绍了消息队列。SQS是一个完全托管的AWS队列服务，可以根据客户流量需求自动扩展。它是一个高可用性的服务，不需要客户端的任何维护和部署工作。SQS突出的一些关键用例是:

*应用解耦*

两个微服务之间不直接交互，而是通过SQS进行通信。这避免了任何服务依赖，这样一个服务关闭不会影响另一个服务。

*背压控制*

从SQS消费消息的客户端可以以自己的速率消费消息。SQS中的消息最多保留14天，或根据客户配置保留。

让我们了解与SQS相关的重要概念和关键注意事项:

*可见性超时值*

来自队列的消息在被一个消费者接收后不会被删除，而是保存在SQS拥有的临时存储中，直到超时设置(称为可见性超时)。一旦消费者处理了消息，它应该通知SQS在可见性超时内删除消息。在设置为在可见性超时之前不进行通信的场景中，消息再次可供其他消费者使用。它的取值范围从0秒到12小时。

*停留时间*

这是消息在未被任何消费者接收的情况下保留在队列中的时间。它的值从1分钟到14天不等。

*Dead Letter队列*

在某些情况下，消费者可能无法处理消息，但我们可能需要该消息用于用例，例如在一段时间后重试或用于调试目的。这就是死信队列(DLQ)可以提供帮助的地方——使用者可以将失败的消息推送到DLQ，以便在稍后的时间点进行任何进一步的操作。

*最大消息大小*

允许的最大消息大小为256KB。这个允许的大小对于所有标准用例来说应该足够好，但是对于需要更多的场景，我们建议您考虑S3或DDB。消息可以存储为S3或DDB对象，并且可以在SQS消息中引用它们。

*消息传递*

两个消费者不能同时竞争一条消息，只有一个线程可以一次处理一条消息。这确保了可靠性，因为多个生产者可以发送消息，多个消费者可以接收消息。

*SQS类型*

SQS提供两种类型的队列——标准队列和先进先出队列。标准队列不能保证消息的顺序，而FIFO保证消息的顺序，详细的比较请参见表12-1。

|对比参数|标准队列|FIFO队列|
|---|---|---|
|消息排序|消息排序以最佳努力为基础。不能保证消息的传递顺序与SQS接收的顺序相同。|消息排序得到了保证。|
|吞吐量|无限吞吐量，可根据客户需求进行扩展。|最大允许是300tps。此外，请求可以以10个为一批进行批处理，因此通过这种方式，基本上我们可以实现最大3000 TPS。
|消息传递|消息可能不止一次地传递给客户端，标准队列确保至少一次传递。应用程序逻辑应该是幂等的，以避免意外行为。|消息只传递一次。
|成本|比FIFO相对便宜。|比标准排队贵25%。|

SQS与简单通知服务(Simple Notification Service, SNS)一起广泛使用，以满足消息代理需求，而无需实际维护任何基础设施，例如支持消息发送用例。要将单个消息传递给多个收件人，可以将其发布到多个SQS订阅的SNS主题。消息的副本被发送到每个SQS，客户端可以从中独立地处理消息。让我们深入研究一下sns——我们将讨论它解决了哪些用例，以及它与SQS有何不同。

## Amazon Simple Notification Service

SNS是生产者和消费者之间进行沟通的中介服务。生产者向SNS主题发布消息，SNS负责通过推送机制将消息转发给所有订阅方(也就是消费者)。支持的消费者是Amazon Kinesis Data Firehose流、SQS、Lambda、HTTP(S)端点、电子邮件、移动推送通知和移动文本消息。回到前几章的Cafe Delhi Heights餐厅的例子，让我们稍微考虑一下我们在手机上获得的不同优惠和优惠券。由于您的电话号码已保存到餐厅系统中，并且您同意接收短信，因此如果有任何新的优惠或折扣，餐厅会发送短信。在这里，餐厅是一个消息生产者，它向折扣渠道发布消息，我们作为订阅者获得这些消息。

在讨论与SNS相关的重要概念之前，让我们先通过表12-2了解一下SQS和SNS的主要区别。

|比较参数|sqs|sns|
|---|---|---|
|消息传递机制|应用程序应该从SQS轮询消息。|SNS将消息推送给其订阅者。|
|并行性|任何时候只有单个消费者可以访问消息，并且一旦消息被处理，消费者有责任从队列中删除消息。|SNS将消息并行地推送给所有消费者，每个消费者可以独立地处理消息。|
|消息传递延迟|由于从SQS轮询消息是应用程序的责任，因此可能会引入一些延迟。|消息一经发布(近乎实时)到SNS主题，就会立即传递给消费者。|

从上面的区别可以清楚地看出，SQS和SNS解决的用例不同，一个服务不应该被视为另一个服务的替代品。现在，让我们通过探讨与社交媒体相关的重要概念和关键考虑因素来进一步探讨社交媒体:

*消息属性*

消息属性是可选的元数据项，可以与消息的消息体一起发送，由键、值和类型表示，支持的类型是String、String。数组，二进制和数字。这些属性可用于在不处理消息体的情况下对消息采取适当的操作。消息属性可用于在订阅者级别筛选消息。例如，一个SNS主题发布整个亚洲大陆的天气状况消息，并且在消息属性中包含国家代码。因此，如果应用程序只想处理印度特定的消息，它可以直接过滤掉其他消息，甚至不需要读取消息。

*信息过滤*

在上面的一个示例中，您看到了消息属性如何在消息过滤中发挥作用。这是通过为主题订阅分配筛选策略来实现的，这样只会将预期的消息传递给订阅者。过滤策略也可以应用于消息体，但消息体应该是格式良好的JSON对象。

*消息的耐久性*

从发布者接收到的消息在确认成功之前存储在多个az中。这确保了消息的可用性，即使在可用分区停机期间也是如此。

*消息传递失败处理*

可能存在订阅者无法接收消息的情况，因此SNS具有基于传递协议的重试策略，以克服不可用性问题。如果消息在重试后仍未传递，我们可以配置一个死信队列，以便消息被推送到那里，并在系统重新联机时进行轮询。

*信息安全*

为了确保数据安全或处理敏感数据，我们可以通过指定AWS KMS密钥在SNS主题上启用服务器端加密(SSE)。启用后，SNS会对接收到的消息进行加密，并以加密的形式存储。在将消息转发给主题订阅者时对其进行解密。SSE只加密消息体，因此我们建议避免在主题和消息元数据中存储任何敏感信息。

*消息顺序*

为了满足严格的消息排序需求并防止消息重复，SNS支持类似于我们在SQS中讨论的FIFO主题。如果没有这样的需求，我们可以默认使用标准主题。

SQS、Lambda和SNS的组合被广泛用于多个用例，以支持事件驱动的异步架构和编排简单的工作流。对于需要在事件驱动的步骤中编排复杂工作流的用例，让我们探索一下AWS提供的工作流编排服务。

## 工作流编排

### AWS步骤函数

### Amazon Managed Workflow for Apache Airflow

## Amazon CloudWatch

### 应用日志

### 监测与报警

## AWS Identity与访问管理

## Amazon Cognito

## AWS AppSync

## 结论
